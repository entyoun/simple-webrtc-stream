<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Audio Stream</title>
    <meta charset="utf-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        #status {
            margin: 20px 0;
            padding: 10px;
            border-radius: 5px;
            background: #f8f9fa;
        }
        .connected {
            background: #d4edda !important;
            color: #155724;
        }
        .error {
            background: #f8d7da !important;
            color: #721c24;
        }
        #info {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>WebSocket Timestamp Stream</h1>
    
    <div id="info">
        <strong>Network Connectivity Monitor</strong><br>
        This application receives timestamp messages every 100ms through WebSockets.
        Perfect for detecting gaps in network connectivity.
    </div>
    
    <p>Click "Start Stream" to begin receiving timestamps from the server via WebSocket.</p>
    
    <button id="startBtn" onclick="start()">Start Stream</button>
    <button id="stopBtn" onclick="stop()" disabled>Stop Stream</button>
    
    <div id="status">Ready to connect...</div>
    
    <div id="timestampDisplay" style="font-family: monospace; background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 20px; border: 1px solid #ddd;">
        <div><strong>Latest Message:</strong></div>
        <div id="latestTimestamp">Waiting for data...</div>
        <div style="margin-top: 10px;"><strong>Message Count:</strong> <span id="messageCount">0</span></div>
        <div><strong>Last Gap:</strong> <span id="lastGap">None detected</span></div>
    </div>

    <script>
        let ws = null;
        let audioContext = null;
        let audioElement = document.getElementById('audioElement');
        let startBtn = document.getElementById('startBtn');
        let stopBtn = document.getElementById('stopBtn');
        let status = document.getElementById('status');

        function updateStatus(message, className = '') {
            status.textContent = message;
            status.className = className;
        }

        async function start() {
            try {
                startBtn.disabled = true;
                updateStatus('Connecting to WebSocket...');

                // Create WebSocket connection
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws`;
                
                ws = new WebSocket(wsUrl);
                ws.binaryType = 'arraybuffer';

                ws.onopen = () => {
                    console.log('WebSocket connected');
                    updateStatus('Connected - initializing audio...', 'connected');
                    initializeAudio();
                    
                    // Request to start streaming
                    ws.send(JSON.stringify({ action: 'start_stream' }));
                };

                ws.onmessage = async (event) => {
                    if (typeof event.data === 'string') {
                        try {
                            const data = JSON.parse(event.data);
                            if (data.type === 'timestamp') {
                                handleTimestamp(data);
                            }
                        } catch (e) {
                            console.error('Error parsing message:', e);
                        }
                    }
                };

                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    updateStatus('WebSocket connection error', 'error');
                    startBtn.disabled = false;
                };

                ws.onclose = () => {
                    console.log('WebSocket disconnected');
                    updateStatus('Disconnected');
                    stop();
                };

            } catch (error) {
                console.error('Error starting stream:', error);
                updateStatus('Error: ' + error.message, 'error');
                startBtn.disabled = false;
            }
        }

        let lastMessageCount = 0;
        let lastReceiveTime = 0;

        async function initializeAudio() {
            try {
                updateStatus('Connected - receiving timestamp stream', 'connected');
                stopBtn.disabled = false;
                // Reset all counters for new stream
                lastMessageCount = 0;
                lastReceiveTime = Date.now();
                // Clear display
                document.getElementById('latestTimestamp').textContent = 'Waiting for data...';
                document.getElementById('messageCount').textContent = '0';
                document.getElementById('lastGap').textContent = 'None detected';
                document.getElementById('lastGap').style.color = '';
            } catch (error) {
                console.error('Error initializing:', error);
                updateStatus('Error initializing: ' + error.message, 'error');
            }
        }

        function handleTimestamp(data) {
            const now = Date.now();
            const timeSinceLastMessage = now - lastReceiveTime;
            
            // Update display
            document.getElementById('latestTimestamp').textContent = data.timestamp_iso;
            document.getElementById('messageCount').textContent = data.message_count;
            
            // Check for gaps (more than 150ms indicates a missed message)
            if (lastReceiveTime > 0 && timeSinceLastMessage > 150) {
                const gapDuration = timeSinceLastMessage;
                const missedMessages = data.message_count - lastMessageCount - 1;
                document.getElementById('lastGap').textContent = 
                    `${gapDuration}ms gap, ${missedMessages} missed messages`;
                document.getElementById('lastGap').style.color = '#dc3545';
                console.warn(`Network gap detected: ${gapDuration}ms, missed ${missedMessages} messages`);
            }
            
            lastMessageCount = data.message_count;
            lastReceiveTime = now;
        }

        function stop() {
            if (ws) {
                ws.close();
                ws = null;
            }
            
            // Reset all display and state
            document.getElementById('latestTimestamp').textContent = 'Disconnected';
            document.getElementById('messageCount').textContent = '0';
            document.getElementById('lastGap').textContent = 'None detected';
            document.getElementById('lastGap').style.color = '';
            lastMessageCount = 0;
            lastReceiveTime = 0;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            updateStatus('Disconnected');
        }

        window.addEventListener('beforeunload', stop);
    </script>
</body>
</html>